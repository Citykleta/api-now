# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
#version: 2.1
jobs:
  set_up_db:
    machine: true
    steps:
      - checkout
      - run:
          name: install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.6.1
      - run:
          name: start cutom db image
          environment:
          command: |
            docker run -d --name db --env-file $PWD/test/test.env -p 5432:5432 citykleta/db:latest
      - run:
          name: import fixture file into container
          command: |
            docker cp $PWD/test/fixture/osm_data.osm db:/osm-data/fixture.osm
      - run:
          name: Wait for db
          command: dockerize -wait tcp://localhost:5432 -timeout 1m
      - run:
          name: import data into the db
          command: |
            docker exec db import_data osm-data/fixture.osm
          environment:
            - POSTGRES_USER: tester
            - POSTGRES_DB: test
            - POSTGRES_PASSWORD: secrettest
            - PGPORT: 5432
            - PGHOST: 127.0.0.1
workflows:
  version: 2
  build_and_test:
    jobs:
      - set_up_db

#version:2
#jobs:
#  build:
#    docker:
#      - image: circleci/


#jobs:
#  build:
#    docker:
#      - image: circleci/node:latest
#      - image: citykleta/db:latest
#        environment:
#          - POSTGRES_USER: tester
#          - POSTGRES_DB: test
#          - POSTGRES_PASSWORD: secrettest
#    steps:
#      - checkout
#
#      # Download and cache dependencies
#      - restore_cache:
#          keys:
#            - v1-dependencies-{{ checksum "package.json" }}
#            # fallback to using the latest cache if no exact match is found
#            - v1-dependencies-
#
#      - run: npm install && npm run build
#
#      - save_cache:
#          paths:
#            - node_modules
#          key: v1-dependencies-{{ checksum "package.json" }}
#
#      # run tests!
#      - run: npm run test
